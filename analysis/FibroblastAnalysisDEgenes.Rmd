---
title: "FibroblastAnalysisDEgenes"
author: "A.DeMartin"
date: "2024-07-17"
output: 
  html_document:
    keep_md: true
    toc: true
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
options(width = 100)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dev = c("png", "pdf"))
seed <- 1234
```

## load packages
```{r load packages}
library(ExploreSCdataSeurat3)
library(runSeurat3)
library(Seurat)
library(ggpubr)
library(pheatmap)
library(SingleCellExperiment)
library(dplyr)
library(tidyverse)
library(viridis)
library(muscat)
library(circlize)
library(destiny)
library(scater)
library(metap)
library(multtest)
library(clusterProfiler)
library(org.Mm.eg.db)
library(msigdbr)
library(enrichplot)
library(DOSE)
library(grid)
library(gridExtra)
library(ggupset)
library(VennDiagram)
```

## load object merged allFb d4
```{r load object merged allFb d4}
##load object merged allFb naive and d4
fileNam <- "/Users/immbio/Desktop/Project/Angelina/Cxcl13Hpb/data/merged_allFb_naiveANDd4_seurat.rds"
seuratFb <- readRDS(fileNam)
table(seuratFb$dataset)
```

## set color vectors 
```{r colors}
## set vector for cond2
colcond2 <- c("#202547","#BE3144")
names(colcond2) <- c("WT", "cko")

## set vector for cond2
colcond3 <- c("#B45B5C","#628395","#BF782D")
names(colcond3) <- c("infectedD4", "naive", "granulomaD4")

#colPal <- c("#355C7D", "#8E9B97","#779d8d","#0F1F38","#E84A5F","#FF847C","#F8B195", "#727077", "#C06C84","#2A363B", "#6C5B7B")
#names(colPal) <- c("0" ,"1", "2", "3", "4", "5", "6", "7", "8", "9", "10")

colPal <- c("#355C7D", "#8E9B97","#99B898","#E84A5F","#0F1F38","#FF847C","#F8B195","#6C5B7B", "#C06C84", "#727077")
names(colPal) <- c("0" ,"1", "2", "3","4", "5", "6", "7", "8", "9")

colclustername <- c("#355C7D", "#8E9B97","#99B898","#E84A5F","#0F1F38","#F8B195","#727077","#FF847C","#C06C84","#904D39")
names(colclustername) <- c("PdgfraloFb1" ,"PdgfraloFb2", "Trophocytes","PdgfraloFb3", "Telocytes","Myocytes", "Pdgfrahi", "PdgfraloFb4", "Thy1Fb", "Glial")
```

## calculate cluster marker genes
```{r marker gens, include=TRUE, eval=FALSE}
## calculate marker genes
Idents(seuratFb) <- seuratFb$clustername
levels(seuratFb)

markerGenes <- FindAllMarkers(seuratFb, only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) 

write.table(markerGenes, 
            file= "/Users/immbio/Desktop/Project/Angelina/Cxcl13Hpb/analysis/FbmarkerGenesclustername.txt",
            sep="\t",
            quote=F,
            row.names=F,
            col.names=T)
```

## calculate DE genes according to cond3
```{r DE genes cond3, include=TRUE, eval=FALSE}
## calculate DE genes
Idents(seuratFb) <- seuratFb$cond3
levels(seuratFb)

DEGenesFbcond3 <- FindAllMarkers(seuratFb, only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) 

write.table(DEGenesFbcond3, 
            file= "/Users/immbio/Desktop/Project/Angelina/Cxcl13Hpb/analysis/DEGenesFbcond3.txt",
            sep="\t",
            quote=F,
            row.names=F,
            col.names=T)
```

## GSEA Fb gran
```{r GSEA Fb gran, fig.height=12, fig.width=12}
## load DEGenesFbcond3
DEGenesFbcond3 <- read.delim("/Users/immbio/Desktop/Project/Angelina/Cxcl13Hpb/data/DEGenesFbcond3.txt", header = TRUE, sep = "\t")

## GSEA on genes upregulated in granulomaFb
##adjust table
DEGenesGran <- dplyr::filter(DEGenesFbcond3, cluster == "granulomaD4")
DEGenesGran <- DEGenesGran %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

##GSEA Gran
egoGran <- enrichGO(gene = unique(DEGenesGran$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egoGran <- setReadable(egoGran, OrgDb = org.Mm.eg.db)
dotplot(egoGran, showCategory=30)
```

## barplot GSEA gran
```{r barplot GSEA Fb gran, fig.height=5, fig.width=12}
#select pahtways and filter file
selGran <- c("leukocyte migration","regulation of innate immune response", "mitochondrial translation", "response to interferon-beta")
egoGran_fil <- egoGran%>% filter(egoGran@result$Description %in% selGran)

egoGran_fil_2 <- pairwise_termsim(egoGran_fil)
#make ggbarplot
p <- ggbarplot(egoGran_fil_2@result, x = "Description", y = "Count", fill = "#BF782D", color= "#BF782D", sort.val = "asc", orientation = "horizontal")
p
```

## convert to sce 
```{r convert to sce}
##convert seurat object to sce object
sce <- as.SingleCellExperiment(seuratFb)
genes <- data.frame(geneID=rownames(sce)) %>% mutate(gene=gsub(".*\\.", "", geneID))
pal = colorRampPalette(c("#053061", "#2166ac", "#f7f7f7", "#f4a582", "#b2183c", "#85122d"))

##subset naive and convert to sce
seuratFbnaive <- subset(seuratFb, cond3 == "naive")
DimPlot(seuratFbnaive, reduction= "umap") + theme(legend.position = "none")
sceFbnaive <- as.SingleCellExperiment(seuratFbnaive)

##subset SI and convert to sce
seuratFbinf <- subset(seuratFb, cond3 == "infectedD4")
DimPlot(seuratFbinf, reduction= "umap") + theme(legend.position = "none")
sceFbinf <- as.SingleCellExperiment(seuratFbinf)

##subset Gran and convert to sce
seuratFbgran <- subset(seuratFb, cond3 == "granulomaD4")
DimPlot(seuratFbgran, reduction= "umap") + theme(legend.position = "none")
sceFbgran <- as.SingleCellExperiment(seuratFbgran)
```

## plot GSEA signatures onto umaps gran
```{r plot GSEA leukocyte migration}
## GSEA on genes upregulated in granuloma
ego1 <- dplyr::filter(egoGran@result,egoGran@result$Description=="leukocyte migration")
g1 <- ego1$geneID
Str <-(g1)
StrSub <- strsplit(Str, "/")
df <- as.data.frame(StrSub)
colnames(df) <- c("gene")

signGenes <- genes %>% dplyr::filter(gene %in% df$gene)
##make a count matrix of signature genes
sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSub@assays@data$logcounts)))/nrow(signGenes)
sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.7))
sceSub$sign2[which(sceSub$sign > 0.7)] <- 0.7
##check max and min values
max(sceSub$sign)
plotUMAP(sceSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes naive
sceFbnaiveSub <- sceFbnaive[which(rownames(sceFbnaive) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbnaiveSub@assays@data$logcounts)))/nrow(signGenes)
sceFbnaiveSub$sign <- cntMat
sceFbnaiveSub$sign2 <- sceFbnaiveSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.7))
sceFbnaiveSub$sign2[which(sceFbnaiveSub$sign > 0.7)] <- 0.7
##check max and min values
max(sceFbnaiveSub$sign)
plotUMAP(sceFbnaiveSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbnaiveSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes inf
sceFbinfSub <- sceFbinf[which(rownames(sceFbinf) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbinfSub@assays@data$logcounts)))/nrow(signGenes)
sceFbinfSub$sign <- cntMat
sceFbinfSub$sign2 <- sceFbinfSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.7))
sceFbinfSub$sign2[which(sceFbinfSub$sign > 0.7)] <- 0.7
##check max and min values
max(sceFbinfSub$sign)
plotUMAP(sceFbinfSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbinfSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes gran
sceFbgranSub <- sceFbgran[which(rownames(sceFbgran) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbgranSub@assays@data$logcounts)))/nrow(signGenes)
sceFbgranSub$sign <- cntMat
sceFbgranSub$sign2 <- sceFbgranSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.7))
sceFbgranSub$sign2[which(sceFbgranSub$sign > 0.7)] <- 0.7
##check max and min values
max(sceFbgranSub$sign)
plotUMAP(sceFbgranSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbgranSub, colour_by = "sign2", point_size = 1) + sc
```

```{r plot GSEA positive regualtion of innate immune response}
## GSEA on genes upregulated in granuloma
ego1 <- dplyr::filter(egoGran@result,egoGran@result$Description=="regulation of innate immune response")
g1 <- ego1$geneID
Str <-(g1)
StrSub <- strsplit(Str, "/")
df <- as.data.frame(StrSub)
colnames(df) <- c("gene")

##make a count matrix of signature genes
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)

sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSub@assays@data$logcounts)))/nrow(signGenes)
sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.7))
sceSub$sign2[which(sceSub$sign > 0.7)] <- 0.7
##check max and min values
max(sceSub$sign)
plotUMAP(sceSub, colour_by = "sign2") + sc +
  theme(legend.position = "none", point_size = 1)
plotUMAP(sceSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes naive
sceFbnaiveSub <- sceFbnaive[which(rownames(sceFbnaive) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbnaiveSub@assays@data$logcounts)))/nrow(signGenes)
sceFbnaiveSub$sign <- cntMat
sceFbnaiveSub$sign2 <- sceFbnaiveSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.7))
sceFbnaiveSub$sign2[which(sceFbnaiveSub$sign > 0.7)] <- 0.7
##check max and min values
max(sceFbnaiveSub$sign)
plotUMAP(sceFbnaiveSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbnaiveSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes inf
sceFbinfSub <- sceFbinf[which(rownames(sceFbinf) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbinfSub@assays@data$logcounts)))/nrow(signGenes)
sceFbinfSub$sign <- cntMat
sceFbinfSub$sign2 <- sceFbinfSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.7))
sceFbinfSub$sign2[which(sceFbinfSub$sign > 0.7)] <- 0.7
##check max and min values
max(sceFbinfSub$sign)
plotUMAP(sceFbinfSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbinfSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes gran
sceFbgranSub <- sceFbgran[which(rownames(sceFbgran) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbgranSub@assays@data$logcounts)))/nrow(signGenes)
sceFbgranSub$sign <- cntMat
sceFbgranSub$sign2 <- sceFbgranSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.7))
sceFbgranSub$sign2[which(sceFbgranSub$sign > 0.7)] <- 0.7
##check max and min values
max(sceFbgranSub$sign)
plotUMAP(sceFbgranSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbgranSub, colour_by = "sign2", point_size = 1) + sc
```

## GSEA Fb SI
```{r GSEA Fb SI, fig.height=12, fig.width=12}
## GSEA on genes upregulated in SI
##adjust table
DEGenesinf <- dplyr::filter(DEGenesFbcond3, cluster == "infectedD4")
DEGenesinf <- DEGenesinf %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

##GSEA inf
egoinf <- enrichGO(gene = unique(DEGenesinf$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egoinf <- setReadable(egoinf, OrgDb = org.Mm.eg.db)
dotplot(egoinf, showCategory=30)
```

## barplot GSEA SI
```{r barplot GSEA Fb SI, fig.height=5, fig.width=12}
#select pahtways and filter file
selSI <- c("extracellular matrix organization","regulation of cellular response to growth factor stimulus", "regulation of Wnt signaling pathway", "response to virus")
egoSI_fil <- egoinf%>% filter(egoinf@result$Description %in% selSI)

egoSI_fil_2 <- pairwise_termsim(egoSI_fil)
#make ggbarplot
p <- ggbarplot(egoSI_fil_2@result, x = "Description", y = "Count", fill = "#B45B5C", color= "#B45B5C", sort.val = "asc", orientation = "horizontal")
p
```

## plot GSEA signatures onto umaps inf
```{r plot GSEA extracellular matrix organization}
## GSEA on genes upregulated in inf
ego1 <- dplyr::filter(egoinf@result,egoinf@result$Description=="extracellular matrix organization")
g1 <- ego1$geneID
Str <-(g1)
StrSub <- strsplit(Str, "/")
df <- as.data.frame(StrSub)
colnames(df) <- c("gene")

##make a count matrix of signature genes
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)

sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSub@assays@data$logcounts)))/nrow(signGenes)
sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1.2))
sceSub$sign2[which(sceSub$sign > 1.2)] <- 1.2
##check max and min values
max(sceSub$sign)
plotUMAP(sceSub, colour_by = "sign2") + sc +
  theme(legend.position = "none", point_size = 1)
plotUMAP(sceSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes naive
sceFbnaiveSub <- sceFbnaive[which(rownames(sceFbnaive) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbnaiveSub@assays@data$logcounts)))/nrow(signGenes)
sceFbnaiveSub$sign <- cntMat
sceFbnaiveSub$sign2 <- sceFbnaiveSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1.2))
sceFbnaiveSub$sign2[which(sceFbnaiveSub$sign > 1.2)] <- 1.2
##check max and min values
max(sceFbnaiveSub$sign)
plotUMAP(sceFbnaiveSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbnaiveSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes inf
sceFbinfSub <- sceFbinf[which(rownames(sceFbinf) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbinfSub@assays@data$logcounts)))/nrow(signGenes)
sceFbinfSub$sign <- cntMat
sceFbinfSub$sign2 <- sceFbinfSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1.2))
sceFbinfSub$sign2[which(sceFbinfSub$sign > 1.2)] <- 1.2
##check max and min values
max(sceFbinfSub$sign)
plotUMAP(sceFbinfSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbinfSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes gran
sceFbgranSub <- sceFbgran[which(rownames(sceFbgran) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbgranSub@assays@data$logcounts)))/nrow(signGenes)
sceFbgranSub$sign <- cntMat
sceFbgranSub$sign2 <- sceFbgranSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 1.2))
sceFbgranSub$sign2[which(sceFbgranSub$sign > 1.2)] <- 1.2
##check max and min values
max(sceFbgranSub$sign)
plotUMAP(sceFbgranSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbgranSub, colour_by = "sign2", point_size = 1) + sc
```


```{r plot GSEA regulation of cellular response to growth factor stimulus}
## GSEA on genes upregulated in inf
ego1 <- dplyr::filter(egoinf@result,egoinf@result$Description=="regulation of cellular response to growth factor stimulus")
g1 <- ego1$geneID
Str <-(g1)
StrSub <- strsplit(Str, "/")
df <- as.data.frame(StrSub)
colnames(df) <- c("gene")

##make a count matrix of signature genes
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)

sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSub@assays@data$logcounts)))/nrow(signGenes)
sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.9))
sceSub$sign2[which(sceSub$sign > 0.9)] <- 0.9
##check max and min values
max(sceSub$sign)
plotUMAP(sceSub, colour_by = "sign2") + sc +
  theme(legend.position = "none", point_size = 1)
plotUMAP(sceSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes naive
sceFbnaiveSub <- sceFbnaive[which(rownames(sceFbnaive) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbnaiveSub@assays@data$logcounts)))/nrow(signGenes)
sceFbnaiveSub$sign <- cntMat
sceFbnaiveSub$sign2 <- sceFbnaiveSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.9))
sceFbnaiveSub$sign2[which(sceFbnaiveSub$sign > 0.9)] <- 0.9
##check max and min values
max(sceFbnaiveSub$sign)
plotUMAP(sceFbnaiveSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbnaiveSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes inf
sceFbinfSub <- sceFbinf[which(rownames(sceFbinf) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbinfSub@assays@data$logcounts)))/nrow(signGenes)
sceFbinfSub$sign <- cntMat
sceFbinfSub$sign2 <- sceFbinfSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.9))
sceFbinfSub$sign2[which(sceFbinfSub$sign > 0.9)] <- 0.9
##check max and min values
max(sceFbinfSub$sign)
plotUMAP(sceFbinfSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbinfSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes gran
sceFbgranSub <- sceFbgran[which(rownames(sceFbgran) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbgranSub@assays@data$logcounts)))/nrow(signGenes)
sceFbgranSub$sign <- cntMat
sceFbgranSub$sign2 <- sceFbgranSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.9))
sceFbgranSub$sign2[which(sceFbgranSub$sign > 0.9)] <- 0.9
##check max and min values
max(sceFbgranSub$sign)
plotUMAP(sceFbgranSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbgranSub, colour_by = "sign2", point_size = 1) + sc
```

## GSEA Fb naive
```{r GSEA Fb naive, fig.height=12, fig.width=12}
## GSEA on genes upregulated in naive
##adjust table
DEGenesnaive <- dplyr::filter(DEGenesFbcond3, cluster == "naive")
DEGenesnaive <- DEGenesnaive %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

##GSEA inf
egonaive <- enrichGO(gene = unique(DEGenesnaive$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egonaive <- setReadable(egonaive, OrgDb = org.Mm.eg.db)
dotplot(egonaive, showCategory=30)
```

## barplot GSEA naive
```{r barplot GSEA Fb naive, fig.height=5, fig.width=12}
#select pahtways and filter file
selnaive <- c("negative regulation of phosphate metabolic process", "response to steroid hormone", "G1/S transition of mitotic cell cycle", "regulation of developmental growth")
egonaive_fil <- egonaive%>% filter(egonaive@result$Description %in% selnaive)

egonaive_fil_2 <- pairwise_termsim(egonaive_fil)
#make ggbarplot
p <- ggbarplot(egonaive_fil_2@result, x = "Description", y = "Count", fill = "#628395", color= "#628395", sort.val = "asc", orientation = "horizontal")
p
```

## plot GSEA signatures onto umaps naive
```{r plot GSEA negative regulation of phosphate metabolic process}
## GSEA on genes upregulated in naive
ego1 <- dplyr::filter(egonaive@result,egonaive@result$Description =="negative regulation of phosphate metabolic process")
g1 <- ego1$geneID
Str <-(g1)
StrSub <- strsplit(Str, "/")
df <- as.data.frame(StrSub)
colnames(df) <- c("gene")

##make a count matrix of signature genes
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)

sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSub@assays@data$logcounts)))/nrow(signGenes)
sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.9))
sceSub$sign2[which(sceSub$sign > 0.9)] <- 0.9
##check max and min values
max(sceSub$sign)
plotUMAP(sceSub, colour_by = "sign2") + sc +
  theme(legend.position = "none", point_size = 1)
plotUMAP(sceSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes naive
sceFbnaiveSub <- sceFbnaive[which(rownames(sceFbnaive) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbnaiveSub@assays@data$logcounts)))/nrow(signGenes)
sceFbnaiveSub$sign <- cntMat
sceFbnaiveSub$sign2 <- sceFbnaiveSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.9))
sceFbnaiveSub$sign2[which(sceFbnaiveSub$sign > 0.9)] <- 0.9
##check max and min values
max(sceFbnaiveSub$sign)
plotUMAP(sceFbnaiveSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbnaiveSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes inf
sceFbinfSub <- sceFbinf[which(rownames(sceFbinf) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbinfSub@assays@data$logcounts)))/nrow(signGenes)
sceFbinfSub$sign <- cntMat
sceFbinfSub$sign2 <- sceFbinfSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.9))
sceFbinfSub$sign2[which(sceFbinfSub$sign > 0.9)] <- 0.9
##check max and min values
max(sceFbinfSub$sign)
plotUMAP(sceFbinfSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbinfSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes gran
sceFbgranSub <- sceFbgran[which(rownames(sceFbgran) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbgranSub@assays@data$logcounts)))/nrow(signGenes)
sceFbgranSub$sign <- cntMat
sceFbgranSub$sign2 <- sceFbgranSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.9))
sceFbgranSub$sign2[which(sceFbgranSub$sign > 0.9)] <- 0.9
##check max and min values
max(sceFbgranSub$sign)
plotUMAP(sceFbgranSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbgranSub, colour_by = "sign2", point_size = 1) + sc
```

```{r plot GSEA response to steroid hormone}
## GSEA on genes upregulated in naive
ego1 <- dplyr::filter(egonaive@result,egonaive@result$Description =="response to steroid hormone")
g1 <- ego1$geneID
Str <-(g1)
StrSub <- strsplit(Str, "/")
df <- as.data.frame(StrSub)
colnames(df) <- c("gene")

##make a count matrix of signature genes
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)

sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSub@assays@data$logcounts)))/nrow(signGenes)
sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.9))
sceSub$sign2[which(sceSub$sign > 0.9)] <- 0.9
##check max and min values
max(sceSub$sign)
plotUMAP(sceSub, colour_by = "sign2") + sc +
  theme(legend.position = "none", point_size = 1)
plotUMAP(sceSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes naive
sceFbnaiveSub <- sceFbnaive[which(rownames(sceFbnaive) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbnaiveSub@assays@data$logcounts)))/nrow(signGenes)
sceFbnaiveSub$sign <- cntMat
sceFbnaiveSub$sign2 <- sceFbnaiveSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.9))
sceFbnaiveSub$sign2[which(sceFbnaiveSub$sign > 0.9)] <- 0.9
##check max and min values
max(sceFbnaiveSub$sign)
plotUMAP(sceFbnaiveSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbnaiveSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes inf
sceFbinfSub <- sceFbinf[which(rownames(sceFbinf) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbinfSub@assays@data$logcounts)))/nrow(signGenes)
sceFbinfSub$sign <- cntMat
sceFbinfSub$sign2 <- sceFbinfSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.9))
sceFbinfSub$sign2[which(sceFbinfSub$sign > 0.9)] <- 0.9
##check max and min values
max(sceFbinfSub$sign)
plotUMAP(sceFbinfSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbinfSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes gran
sceFbgranSub <- sceFbgran[which(rownames(sceFbgran) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbgranSub@assays@data$logcounts)))/nrow(signGenes)
sceFbgranSub$sign <- cntMat
sceFbgranSub$sign2 <- sceFbgranSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.9))
sceFbgranSub$sign2[which(sceFbgranSub$sign > 0.9)] <- 0.9
##check max and min values
max(sceFbgranSub$sign)
plotUMAP(sceFbgranSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbgranSub, colour_by = "sign2", point_size = 1) + sc
```

```{r plot GSEA G1/S transition of mitotic cell cycle}
## GSEA on genes upregulated in naive
ego1 <- dplyr::filter(egonaive@result,egonaive@result$Description =="G1/S transition of mitotic cell cycle")
g1 <- ego1$geneID
Str <-(g1)
StrSub <- strsplit(Str, "/")
df <- as.data.frame(StrSub)
colnames(df) <- c("gene")

##make a count matrix of signature genes
signGenes <- genes %>% dplyr::filter(gene %in% df$gene)

sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceSub@assays@data$logcounts)))/nrow(signGenes)
sceSub$sign <- cntMat
sceSub$sign2 <- sceSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.8))
sceSub$sign2[which(sceSub$sign > 0.8)] <- 0.8
##check max and min values
max(sceSub$sign)
plotUMAP(sceSub, colour_by = "sign2") + sc +
  theme(legend.position = "none", point_size = 1)
plotUMAP(sceSub, colour_by = "sign2", point_size = 1) + sc

##make a count matrix of signature genes naive
sceFbnaiveSub <- sceFbnaive[which(rownames(sceFbnaive) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbnaiveSub@assays@data$logcounts)))/nrow(signGenes)
sceFbnaiveSub$sign <- cntMat
sceFbnaiveSub$sign2 <- sceFbnaiveSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.8))
sceFbnaiveSub$sign2[which(sceFbnaiveSub$sign > 0.8)] <- 0.8
##check max and min values
max(sceFbnaiveSub$sign)
plotUMAP(sceFbnaiveSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbnaiveSub, colour_by = "sign2", point_size = 1) + sc


##make a count matrix of signature genes inf
sceFbinfSub <- sceFbinf[which(rownames(sceFbinf) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbinfSub@assays@data$logcounts)))/nrow(signGenes)
sceFbinfSub$sign <- cntMat
sceFbinfSub$sign2 <- sceFbinfSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.8))
sceFbinfSub$sign2[which(sceFbinfSub$sign > 0.8)] <- 0.8
##check max and min values
max(sceFbinfSub$sign)
plotUMAP(sceFbinfSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbinfSub, colour_by = "sign2", point_size = 1) + sc


##make a count matrix of signature genes gran
sceFbgranSub <- sceFbgran[which(rownames(sceFbgran) %in% signGenes$geneID),]
cntMat <- rowSums(t(as.matrix(
    sceFbgranSub@assays@data$logcounts)))/nrow(signGenes)
sceFbgranSub$sign <- cntMat
sceFbgranSub$sign2 <- sceFbgranSub$sign
sc <- scale_colour_gradientn(colours = pal(100), limits=c(0, 0.8))
sceFbgranSub$sign2[which(sceFbgranSub$sign > 0.8)] <- 0.8
##check max and min values
max(sceFbgranSub$sign)
plotUMAP(sceFbgranSub, colour_by = "sign2", point_size = 1) + sc +
  theme(legend.position = "none")
plotUMAP(sceFbgranSub, colour_by = "sign2", point_size = 1) + sc
```


## calculate DE genes according to cond2
```{r DE genes cond2, include=TRUE, eval=FALSE}
## calculate DE genes
Idents(seuratFb) <- seuratFb$cond2
levels(seuratFb)

DEGenesFbcond2 <- FindAllMarkers(seuratFb, only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) 

write.table(DEGenesFbcond2, 
            file= "/Users/immbio/Desktop/Project/Angelina/Cxcl13Hpb/analysis/DEGenesFbcond2.txt",
            sep="\t",
            quote=F,
            row.names=F,
            col.names=T)
```

## GSEA wt
```{r GSEA Fb wt, fig.height=12, fig.width=12}
## load DEGenesFbcond2
DEGenesFbcond2 <- read.delim("/Users/immbio/Desktop/Project/Angelina/Cxcl13Hpb/data/DEGenesFbcond2.txt", header = TRUE, sep = "\t")
## GSEA on genes upregulated in wt
##adjust table
DEGeneswt <- dplyr::filter(DEGenesFbcond2, cluster == "WT")
DEGeneswt <- DEGeneswt %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

##GSEA WT
egowt <- enrichGO(gene = unique(DEGeneswt$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egowt <- setReadable(egowt, OrgDb = org.Mm.eg.db)
dotplot(egowt, showCategory=30)
```
## barplot GSEA wt
```{r barplot GSEA wt, fig.height=5, fig.width=12}
#select pahtways and filter file
selwt <- c("Wnt signaling pathway","extracellular matrix organization")
egowt_fil <- egowt%>% filter(egowt@result$Description %in% selwt)

egowt_fil_2 <- pairwise_termsim(egowt_fil)
#make ggbarplot
p <- ggbarplot(egowt_fil_2@result, x = "Description", y = "Count", fill = "#202547", color= "#202547", sort.val = "asc", orientation = "horizontal")
p
```

### dotplot top 10 DE genes wt
```{r dotplot top 10 DE wt, fig.height=6, fig.width=7}
genes <- data.frame(gene=rownames(seuratFb)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=(c("Wdfy1", "Rab18", "Il33", "Rgs5", "C3", "Serpina3n", "Pcsk5", "Tff2", "Rsrp1", "Dpt", "Col6a3", "Col6a2"))) %>% left_join(., genes, by="geneID")

DotPlot(seuratFb, features = selGenes, group.by= "cond3") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2_plus_cond3") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## GSEA cko
```{r GSEA Fb cko, fig.height=12, fig.width=12}
## GSEA on genes upregulated in cko
##adjust table
DEGenescko <- dplyr::filter(DEGenesFbcond2, cluster == "cko")
DEGenescko <- DEGenescko %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

##GSEA cko
egocko <- enrichGO(gene = unique(DEGenescko$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egocko <- setReadable(egocko, OrgDb = org.Mm.eg.db)
dotplot(egocko, showCategory=30)
```
## barplot GSEA cko
```{r barplot GSEA cko, fig.height=5, fig.width=12}
#select pahtways and filter file
selcko <- c("ribonucleotide metabolic process","cellular respiration")
egocko_fil <- egocko%>% filter(egocko@result$Description %in% selcko)

egocko_fil_2 <- pairwise_termsim(egocko_fil)
#make ggbarplot
p <- ggbarplot(egocko_fil_2@result, x = "Description", y = "Count", fill = "#BE3144", color= "#BE3144", sort.val = "asc", orientation = "horizontal")
p
```

### dotplot top 10 DE genes cko
```{r dotplot top 10 DE cko, fig.height=6, fig.width=7}
genes <- data.frame(gene=rownames(seuratFb)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=(c("mt-Nd3","Isg15", "Anxa1", "Tubb4b", "	
Cd9", "Abhd1", "Manf", "Dynll1", "Rpl35a", "Tuba1a", "Calm1", "Pdia6"))) %>% left_join(., genes, by="geneID")

DotPlot(seuratFb, features = selGenes, group.by= "cond3") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2_plus_cond3") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```


### filter top10 genes of each pathway wt
```{r filter top 10 genes, fig.height=6, fig.width=7}
egowt_fil.1 <- egowt%>% filter(egowt@result$Description == "Wnt signaling pathway")

g1 <- egowt_fil.1$geneID
Str <- (g1)
strSub <- strsplit(Str, "/")
df <- as.data.frame(strSub)
colnames(df) <- c ("gene")

DEGenesfil <- DEGeneswt %>% dplyr::filter((Gene %in% df$gene)) 
DEGenesfiltop10.1 <- DEGenesfil %>% dplyr::top_n(10, -p_val_adj)

egowt_fil.2 <- egowt%>% filter(egowt@result$Description == "extracellular matrix organization")

g1 <- egowt_fil.2$geneID
Str <- (g1)
strSub <- strsplit(Str, "/")
df <- as.data.frame(strSub)
colnames(df) <- c ("gene")

DEGenesfil <- DEGeneswt %>% dplyr::filter((Gene %in% df$gene)) 
DEGenesfiltop10.2 <- DEGenesfil %>% dplyr::top_n(10, -p_val_adj)

joined_df <- dplyr::bind_rows(DEGenesfiltop10.1, DEGenesfiltop10.2)

unique_df <- joined_df %>% dplyr::distinct(Gene, .keep_all = TRUE)
genesPlot1 <- unique_df %>% dplyr::select(Gene) %>% dplyr::rename(gene = Gene)
```

## average Heatmap top 10 genes of each pathway wt
```{r avg heatmap top 10 wt, fig.width=5, fig.height=6}
Idents(seuratFb) <- seuratFb$cond2_plus_cond3
levels(seuratFb)
seurat <- seuratFb
levels(seurat)

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(gsub("(_.*)","",colnames(logNormExpresMa)))%>%
    dplyr::mutate(celltype=colnames(logNormExpresMa))
  colnames(annotation_col)[1] <- "cond"
  colnames(annotation_col)[2] <- "celltype"
    annotation_col <- annotation_col %>%
    dplyr::mutate(celltype = gsub("(^.*?_)","",celltype))
  #annotation_col <- annotation_col %>%
    #dplyr::mutate(cond = gsub("(^[0-9]_?)","",col1)) %>%
   # dplyr::select(cond, celltype)
 rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colcond2,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
     ordVec <- c("WT_naive" ,"cko_naive","WT_infectedD4","cko_infectedD4","WT_granulomaD4","cko_granulomaD4")
     
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

##genes
#	cytokine-mediated signaling pathway
#negative regulation of endopeptidase activity
genesPlot <- genesPlot1

levels(seurat)
colVec <- colcond3
# colVec <- c(colPal, colPal, colPal)
# colVec <- c("blue", "red")
avgHeatmap(seurat, selGenes = genesPlot, colVecIdent = colVec)
```

```{r avg heatmap top 10 wt-ord2, fig.width=5, fig.height=6}
Idents(seuratFb) <- seuratFb$cond2_plus_cond3
levels(seuratFb)
seurat <- seuratFb
levels(seurat)

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(gsub("(_.*)","",colnames(logNormExpresMa)))%>%
    dplyr::mutate(celltype=colnames(logNormExpresMa))
  colnames(annotation_col)[1] <- "cond"
  colnames(annotation_col)[2] <- "celltype"
    annotation_col <- annotation_col %>%
    dplyr::mutate(celltype = gsub("(^.*?_)","",celltype))
  #annotation_col <- annotation_col %>%
    #dplyr::mutate(cond = gsub("(^[0-9]_?)","",col1)) %>%
   # dplyr::select(cond, celltype)
 rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colcond2,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
     ordVec <- c("WT_naive" ,"WT_infectedD4","WT_granulomaD4","cko_naive","cko_infectedD4","cko_granulomaD4")
     
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

##genes
#	cytokine-mediated signaling pathway
#negative regulation of endopeptidase activity
genesPlot <- genesPlot1

levels(seurat)
colVec <- colcond3
# colVec <- c(colPal, colPal, colPal)
# colVec <- c("blue", "red")
avgHeatmap(seurat, selGenes = genesPlot, colVecIdent = colVec)
```

### filter top10 genes of each pathway cko
```{r filter top 10 genes cko, fig.height=6, fig.width=7}
egocko_fil.3 <- egocko%>% filter(egocko@result$Description == "ribonucleotide metabolic process")

g1 <- egocko_fil.3$geneID
Str <- (g1)
strSub <- strsplit(Str, "/")
df <- as.data.frame(strSub)
colnames(df) <- c ("gene")

DEGenesfil <- DEGenescko %>% dplyr::filter((Gene %in% df$gene)) 
DEGenesfiltop10.3 <- DEGenesfil %>% dplyr::top_n(10, -p_val_adj)

egocko_fil.4 <- egocko%>% filter(egocko@result$Description == "cellular respiration")

g1 <- egocko_fil.4$geneID
Str <- (g1)
strSub <- strsplit(Str, "/")
df <- as.data.frame(strSub)
colnames(df) <- c("gene")

DEGenesfil <- DEGenescko %>% dplyr::filter((Gene %in% df$gene)) 
DEGenesfiltop10.4 <- DEGenesfil %>% dplyr::top_n(10, -p_val_adj)

joined_df <- dplyr::bind_rows(DEGenesfiltop10.3, DEGenesfiltop10.4)

unique_df <- joined_df %>% dplyr::distinct(Gene, .keep_all = TRUE)
genesPlot1 <- unique_df %>% dplyr::select(Gene) %>% dplyr::rename(gene = Gene)
```

## average Heatmap top 10 genes of each pathway cko
```{r avg heatmap top 10 cko, fig.width=5, fig.height=6}
Idents(seuratFb) <- seuratFb$cond2_plus_cond3
levels(seuratFb)
seurat <- seuratFb
levels(seurat)

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(gsub("(_.*)","",colnames(logNormExpresMa)))%>%
    dplyr::mutate(celltype=colnames(logNormExpresMa))
  colnames(annotation_col)[1] <- "cond"
  colnames(annotation_col)[2] <- "celltype"
    annotation_col <- annotation_col %>%
    dplyr::mutate(celltype = gsub("(^.*?_)","",celltype))
  #annotation_col <- annotation_col %>%
    #dplyr::mutate(cond = gsub("(^[0-9]_?)","",col1)) %>%
   # dplyr::select(cond, celltype)
 rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colcond2,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
     ordVec <- c("WT_naive" ,"cko_naive","WT_infectedD4","cko_infectedD4","WT_granulomaD4","cko_granulomaD4")
     
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

##genes
#	cytokine-mediated signaling pathway
#negative regulation of endopeptidase activity
genesPlot <- genesPlot1

levels(seurat)
colVec <- colcond3
# colVec <- c(colPal, colPal, colPal)
# colVec <- c("blue", "red")
avgHeatmap(seurat, selGenes = genesPlot, colVecIdent = colVec)
```

```{r avg heatmap top 10 cko-ord2, fig.width=5, fig.height=6}
Idents(seuratFb) <- seuratFb$cond2_plus_cond3
levels(seuratFb)
seurat <- seuratFb
levels(seurat)

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(gsub("(_.*)","",colnames(logNormExpresMa)))%>%
    dplyr::mutate(celltype=colnames(logNormExpresMa))
  colnames(annotation_col)[1] <- "cond"
  colnames(annotation_col)[2] <- "celltype"
    annotation_col <- annotation_col %>%
    dplyr::mutate(celltype = gsub("(^.*?_)","",celltype))
  #annotation_col <- annotation_col %>%
    #dplyr::mutate(cond = gsub("(^[0-9]_?)","",col1)) %>%
   # dplyr::select(cond, celltype)
 rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colcond2,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
     ordVec <- c("WT_naive" ,"WT_infectedD4","WT_granulomaD4","cko_naive","cko_infectedD4","cko_granulomaD4")
     
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

##genes
#	cytokine-mediated signaling pathway
#negative regulation of endopeptidase activity
genesPlot <- genesPlot1

levels(seurat)
colVec <- colcond3
# colVec <- c(colPal, colPal, colPal)
# colVec <- c("blue", "red")
avgHeatmap(seurat, selGenes = genesPlot, colVecIdent = colVec)
```

## Venn diagram
```{r Venn}
## load DEGenesFbcond2
DEGenesFbcond2 <- read.delim("/Users/immbio/Desktop/Project/Angelina/Cxcl13Hpb/data/DEGenesFbcond2.txt", header = TRUE, sep = "\t")

DEGenesFbcond2_1 <- DEGenesFbcond2  %>% dplyr::filter(cluster == "WT") 
DEGenesFbcond3_1 <- DEGenesFbcond3 %>% dplyr::filter(cluster == "granulomaD4")

##make Venn Diagram
x <- list(UpInWT=DEGenesFbcond2_1$gene,
          UpInGran=DEGenesFbcond3_1$gene)
library(VennDiagram)
venn.diagram(x, filename = "venn-4-diagram.png")
# Helper function to display Venn diagram
display_venn <- function(z, ...) {
  grid.newpage()
  venn_object <- venn.diagram (z, filename = NULL, ...)
  grid.draw (venn_object)
}
display_venn(x)
# change fill color and circles
display_venn(x, fill = c("#2166AC", "#B2182B"), lwd = 5, lty = 'blank')
## extract genes in intersections
library(gplots)
vTab <- venn(x)
# extract genes in intersections
vTab
# extract genes in intersections
DEGenesintersect <- DEGenesFbcond2_1 %>% dplyr::filter(gene %in% DEGenesFbcond3_1$gene) 
DEGenesintersect1 <- DEGenesFbcond2_1 %>% dplyr::filter(!(gene %in% DEGenesFbcond3_1$gene)) 
DEGenesintersect2 <- DEGenesFbcond3_1 %>% dplyr::filter(gene %in% DEGenesFbcond2_1$gene) 
```

## GSEA on intersect genes
```{r GSEA on intersect genes, fig.height=12, fig.width=12}
##adjust table
DEGenesintersect <- DEGenesintersect %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

##GSEA intersect
egointersect <- enrichGO(gene = unique(DEGenesintersect$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egointersect <- setReadable(egointersect, OrgDb = org.Mm.eg.db)
dotplot(egointersect, showCategory=30)

##adjust table
DEGenesintersect1 <- DEGenesintersect1 %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

##GSEA intersect
egointersect1 <- enrichGO(gene = unique(DEGenesintersect1$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egointersect1 <- setReadable(egointersect1, OrgDb = org.Mm.eg.db)
dotplot(egointersect1, showCategory=30)

egointersect1fil <- dplyr::filter(egointersect1@result, egointersect1@result$Description =="extracellular matrix organization")
g1 <- egointersect1fil$geneID
Str <- (g1)
strSub <- strsplit(Str, "/")
df <- as.data.frame(strSub)
colnames(df) <- c ("gene")

DEGenesintersect1fil <- DEGenesintersect1 %>% dplyr::filter((Gene %in% df$gene)) 
DEGenesintersect1filtop10 <- DEGenesintersect1fil %>% dplyr::top_n(10, -p_val_adj)

egointersect1filWnt <- dplyr::filter(egointersect1@result, egointersect1@result$Description =="Wnt signaling pathway")
g1Wnt <- egointersect1filWnt$geneID
StrWnt <- (g1Wnt)
strSubWnt <- strsplit(StrWnt, "/")
dfWnt <- as.data.frame(strSubWnt)
colnames(dfWnt) <- c ("gene")

DEGenesintersect1filWnt <- DEGenesintersect1 %>% dplyr::filter((Gene %in% dfWnt$gene)) 
DEGenesintersect1filtop10Wnt <- DEGenesintersect1filWnt %>% dplyr::top_n(10, -p_val_adj)

joined_df <- dplyr::bind_rows(DEGenesintersect1filtop10, DEGenesintersect1filtop10Wnt)
unique_df <- joined_df %>% dplyr::distinct(Gene, .keep_all = TRUE)
genesPlot1 <- unique_df %>% dplyr::select(Gene) %>% dplyr::rename(gene = Gene)

############################Gene
##adjust table
DEGenesintersect2 <- DEGenesintersect2 %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

##GSEA intersect
egointersect2 <- enrichGO(gene = unique(DEGenesintersect2$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egointersect2 <- setReadable(egointersect2, OrgDb = org.Mm.eg.db)
dotplot(egointersect2, showCategory=30)
```

## barplot GSEA intersect
```{r barplot GSEA intersect, fig.height=5, fig.width=12}
#select pahtways and filter file
selintersect <- c("response to interleukin-1", "positive regulation of cellular catabolic process", "negative regulation of endopeptidase activity", "cytokine-mediated signaling pathway")
egointersect_fil <- egointersect%>% filter(egointersect@result$Description %in% selintersect)

egointersect_fil_2 <- pairwise_termsim(egointersect_fil)
#make ggbarplot
p <- ggbarplot(egointersect_fil_2@result, x = "Description", y = "Count", fill = "#202547", color= "#202547", sort.val = "asc", orientation = "horizontal")
p
```

## average Heatmap intersect
```{r avg heatmap intersect, fig.width=5, fig.height=6}
Idents(seuratFb) <- seuratFb$cond2_plus_cond3
levels(seuratFb)
seurat <- seuratFb
levels(seurat)

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(gsub("(_.*)","",colnames(logNormExpresMa)))%>%
    dplyr::mutate(celltype=colnames(logNormExpresMa))
  colnames(annotation_col)[1] <- "cond"
  colnames(annotation_col)[2] <- "celltype"
    annotation_col <- annotation_col %>%
    dplyr::mutate(celltype = gsub("(^.*?_)","",celltype))
  #annotation_col <- annotation_col %>%
    #dplyr::mutate(cond = gsub("(^[0-9]_?)","",col1)) %>%
   # dplyr::select(cond, celltype)
 rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colcond2,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
     ordVec <- c("WT_naive" ,"cko_naive","WT_infectedD4","cko_infectedD4","WT_granulomaD4","cko_granulomaD4")
     
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

##genes
#	cytokine-mediated signaling pathway
#negative regulation of endopeptidase activity
genesPlot <- data.frame(gene=c("Ccl11","Ccl21a","Il1r1","Csf2rb2","Osmr","Il1r2","Jak3","Map3k7","Robo1", "Cyld", "Src", "Tslp", "Otud4", "Ptk2b", "Serpina3n", "Hspa1b","Serpina3g","Picalm","Xiap","Serpina3i", "Rps6ka3"))

levels(seurat)
colVec <- colcond3
# colVec <- c(colPal, colPal, colPal)
# colVec <- c("blue", "red")
avgHeatmap(seurat, selGenes = genesPlot, colVecIdent = colVec)
```

```{r avg heatmap intersect - ord2, fig.width=5, fig.height=6}
Idents(seuratFb) <- seuratFb$cond2_plus_cond3
levels(seuratFb)
seurat <- seuratFb
levels(seurat)

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(gsub("(_.*)","",colnames(logNormExpresMa)))%>%
    dplyr::mutate(celltype=colnames(logNormExpresMa))
  colnames(annotation_col)[1] <- "cond"
  colnames(annotation_col)[2] <- "celltype"
    annotation_col <- annotation_col %>%
    dplyr::mutate(celltype = gsub("(^.*?_)","",celltype))
  #annotation_col <- annotation_col %>%
    #dplyr::mutate(cond = gsub("(^[0-9]_?)","",col1)) %>%
   # dplyr::select(cond, celltype)
 rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colcond2,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
     ordVec <- c("WT_naive" ,"WT_infectedD4","WT_granulomaD4","cko_naive","cko_infectedD4","cko_granulomaD4")
     
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

##genes
#	cytokine-mediated signaling pathway
#negative regulation of endopeptidase activity
genesPlot <- data.frame(gene=c("Ccl11","Ccl21a","Il1r1","Csf2rb2","Osmr","Il1r2","Jak3","Map3k7","Robo1", "Cyld", "Src", "Tslp", "Otud4", "Ptk2b", "Serpina3n", "Hspa1b","Serpina3g","Picalm","Xiap","Serpina3i", "Rps6ka3"))

levels(seurat)
colVec <- colcond3
# colVec <- c(colPal, colPal, colPal)
# colVec <- c("blue", "red")
avgHeatmap(seurat, selGenes = genesPlot, colVecIdent = colVec)
```

## average Heatmap intersect1
```{r avg heatmap intersect1, fig.width=5, fig.height=6}
Idents(seuratFb) <- seuratFb$cond2_plus_cond3
levels(seuratFb)
seurat <- seuratFb
levels(seurat)

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(gsub("(_.*)","",colnames(logNormExpresMa)))%>%
    dplyr::mutate(celltype=colnames(logNormExpresMa))
  colnames(annotation_col)[1] <- "cond"
  colnames(annotation_col)[2] <- "celltype"
    annotation_col <- annotation_col %>%
    dplyr::mutate(celltype = gsub("(^.*?_)","",celltype))
  #annotation_col <- annotation_col %>%
    #dplyr::mutate(cond = gsub("(^[0-9]_?)","",col1)) %>%
   # dplyr::select(cond, celltype)
 rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colcond2,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
     ordVec <- c("WT_naive" ,"cko_naive","WT_infectedD4","cko_infectedD4","WT_granulomaD4","cko_granulomaD4")
     
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

##genes
#	cytokine-mediated signaling pathway
#negative regulation of endopeptidase activity
genesPlot <- genesPlot1

levels(seurat)
colVec <- colcond3
# colVec <- c(colPal, colPal, colPal)
# colVec <- c("blue", "red")
avgHeatmap(seurat, selGenes = genesPlot, colVecIdent = colVec)
```

## dotplot cytokine-mediated signling pathway and neg regualtion of endopepitdase activity
```{r dotplot genes GSEA intersect, fig.height=6, fig.width=7}
genes <- data.frame(gene=rownames(seuratFb)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=rev(c("Ccl11","Ccl21a","Il1r1","Csf2rb2","Osmr","Il1r2","Jak3","Map3k7","Robo1", "Cyld", "Src", "Tslp", "Otud4", "Ptk2b", "Serpina3n", "Hspa1b","Serpina3g","Picalm","Xiap","Serpina3i", "Rps6ka3"))) %>% left_join(., genes, by="geneID")

DotPlot(seuratFb, features = selGenes, group.by= "cond3") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2_plus_cond3") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## dotplot cytokine-mediated signling pathway 
```{r dotplot genes GSEA intersect-1, fig.height=5, fig.width=7}
genes <- data.frame(gene=rownames(seuratFb)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=rev(c("Ccl11","Ccl21a","Il1r1","Csf2rb2","Osmr","Il1r2","Jak3","Map3k7","Robo1", "Cyld", "Src", "Tslp", "Otud4", "Ptk2b"))) %>% left_join(., genes, by="geneID")

DotPlot(seuratFb, features = selGenes, group.by= "cond3") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2_plus_cond3") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## neg regualtion of endopepitdase activity
```{r dotplot genes GSEA intersect-2, fig.height=3, fig.width=7}
genes <- data.frame(gene=rownames(seuratFb)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=rev(c("Serpina3n", "Hspa1b","Serpina3g","Picalm","Xiap","Serpina3i", "Rps6ka3"))) %>% left_join(., genes, by="geneID")

DotPlot(seuratFb, features = selGenes, group.by= "cond3") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2_plus_cond3") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2") + RotatedAxis() + scale_color_viridis(option="F") + coord_flip()
```

## session info
```{r date and session info}
date()
sessionInfo()
```
